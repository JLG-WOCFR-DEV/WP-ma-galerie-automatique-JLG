# Audit code & accessibilité – Extension « Lightbox - JLG »

## Synthèse
- Le cœur de l’extension repose sur un fichier JavaScript monolithique de plus de 4 600 lignes qui mêle détection de contenu, génération du DOM, gestion de l’historique, accessibilité et debug. Cette densité rend la maintenance et le test unitaire difficiles et augmente le risque de régressions lors d’évolutions futures.【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L1-L4637】
- L’équipe a porté une attention réelle aux besoins d’accessibilité (structure de dialogue, piégeage du focus, prise en compte de `prefers-reduced-motion`). Néanmoins, certaines personnalisations (couleurs, opacité) peuvent facilement casser les contrastes exigés par le RGAA si l’admin choisit des valeurs non conformes, faute de garde-fous dans le code.【F:ma-galerie-automatique/includes/Frontend/Assets.php†L452-L479】【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L1-L208】【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L605-L651】
- Les outils de diagnostic embarqués sont complets, mais leur interface statique (styles inline, absence de thématisation) n’est pas vérifiée pour la conformité RGAA et pourrait poser problème sur certains contrastes ou lecteurs d’écran.【F:ma-galerie-automatique/assets/js/src/debug.js†L19-L200】

## Points forts constatés
- Création de la visionneuse avec rôle `dialog`, intitulé accessible et conteneur de statut pour la légende, ce qui fournit une base solide pour la lecture par les technologies d’assistance.【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L2504-L2747】
- Ouverture/fermeture gérées avec blocage du scroll, restauration du focus initial et piégeage du focus clavier pendant l’affichage du lightbox.【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L3600-L3680】【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L4501-L4572】
- Modal de partage généré dynamiquement avec attributs ARIA (`aria-modal`, `aria-describedby`, `aria-live`), contrôle de l’état `aria-expanded` du bouton d’invocation et gestion du focus.【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L936-L1268】
- Prise en compte du media-query `prefers-reduced-motion` pour réduire les animations lorsque l’utilisateur le demande.【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L605-L651】

## Risques, bugs et points de vigilance
1. **Dette technique importante dans `gallery-slideshow.js`** – Le fichier agrège l’ensemble des responsabilités (préparation des images, génération HTML, navigation clavier, historique, debug). La moindre régression devient difficile à isoler, et il est ardu de couvrir ce code par des tests ciblés.【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L1-L4637】<br>👉 **Solution proposée :** introduire progressivement des modules ES (ou des fichiers séparés importés via l’outil de build existant) pour lister les dépendances sans toucher aux API publiques : commencer par isoler les fonctions pures (`buildSlideMarkup`, `applyKeyboardNavigation`, etc.) dans `src/modules/`, puis exposer un point d’entrée unique qui ré-exporte les fonctions historiques. Ce découpage peut être fait feature par feature avec des tests unitaires ciblés afin de limiter tout risque de régression.
2. **Focus visible dépendant de `:focus-visible`** – Pour plusieurs contrôles (`.mga-toolbar-button`, vignettes, flèches Swiper), le style par défaut supprime l’outline (`outline: none`) et le remplacement est appliqué uniquement via `:focus-visible`. Les navigateurs ne supportant pas ce pseudo-sélecteur (ou en configuration particulière) pourraient afficher aucun indicateur visuel, ce qui contrevient au RGAA 10.7.【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L185-L189】【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L413-L416】<br>👉 **Solution proposée :** ajouter dans la feuille `gallery-slideshow.css` une règle `.mga-toolbar-button:focus:not(:focus-visible)` qui restaure un `outline` contrasté (ex. `2px solid var(--mga-accent-color)`) et, pour les vignettes, un contour `box-shadow`. Cette modification est purement CSS et n’impacte pas la logique JavaScript.
3. **Absence de contrôle de contraste sur les personnalisations** – Les réglages exposent `accent_color` et `bg_opacity` sans vérifier que la couleur choisie respecte les rapports de contraste requis lorsqu’elle est appliquée aux boutons, icônes ou au fond du viewer. Un administrateur peut ainsi définir un accent clair sur fond clair ou une opacité très faible, générant un affichage non conforme au RGAA 3.2/3.3.【F:ma-galerie-automatique/includes/Frontend/Assets.php†L452-L479】【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L1-L208】<br>👉 **Solution proposée :** dans `Assets.php`, utiliser `wp_check_font_size()` ou un calcul maison (luminosité relative WCAG) avant de persister l’option : si le contraste est < 4.5 :1 pour le texte ou < 3 :1 pour les icônes, déclencher `add_settings_error` pour empêcher l’enregistrement. Fournir en parallèle une prévisualisation dans la page d’options avec un message d’avertissement, ce qui laisse l’UX intacte.
4. **Debug panel non thémable** – Le panneau de diagnostic est construit avec des styles inline et des codes couleur (#4CAF50, #FFC107, #FFEB3B) sur fond sombre. Aucun mécanisme n’assure que les contrastes restent suffisants, ni que l’élément soit ignoré par les lecteurs d’écran quand il n’est pas actif. Cela peut gêner les tests d’accessibilité côté client final.【F:ma-galerie-automatique/assets/js/src/debug.js†L31-L147】<br>👉 **Solution proposée :** déplacer les styles inline vers une feuille `debug.css` chargée conditionnellement lorsque `debug_mode` est actif, définir des classes (`.mga-debug-success`, `.mga-debug-warning`) avec des couleurs AA et appliquer `aria-hidden="true"` lorsque le panneau est réduit. Les annonces d’ouverture/fermeture peuvent être gérées en ajoutant un élément `div` `role="status"` mis à jour via `textContent`, sans modifier la logique métier.
5. **Paramètre d’opacité du fond** – `bg_opacity` peut être ramené à zéro, rendant le fond transparent et laissant le contenu sous-jacent nuire à la lisibilité du diaporama (RGAA 10.5). Aucun plafond plancher n’est imposé en dehors de la borne mathématique.【F:ma-galerie-automatique/includes/Frontend/Assets.php†L462-L474】<br>👉 **Solution proposée :** appliquer `max(0.6, min(1, valeur))` lors de la génération du CSS (côté PHP) et afficher un avertissement si l’utilisateur tente d’enregistrer une valeur < 0.6. Cette contrainte préserve la compatibilité avec les réglages actuels tout en empêchant un fond totalement transparent.

## Évaluation du debug embarqué
- Le module debug expose un panneau riche (horloge, journal des événements, bouton « forcer l’ouverture ») et trace la plupart des actions du lightbox.【F:ma-galerie-automatique/assets/js/src/debug.js†L31-L200】【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L685-L3932】
- L’intégration est propre (feature flag `debug_mode`, chargement conditionnel du script). Cependant, le cycle de vie repose sur un `setInterval` de 100 ms et sur des appels fréquents à `debug.log`, ce qui peut alourdir le thread principal si le mode reste activé sur un site de production.【F:ma-galerie-automatique/assets/js/src/debug.js†L161-L185】【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L685-L3892】<br>👉 Limiter les rafraîchissements quand le panneau est réduit/invisible, et documenter que le mode est réservé aux environnements de recette.

## RGAA : conformité observée
- **Positif :** structure du modal conforme (role, aria-labelledby, aria-describedby), gestion du focus et du scroll, légende en `aria-live`, boutons avec libellés explicites, navigation clavier sur miniatures (flèches, Home/End).【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L936-L1268】【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L3470-L3527】
- **Points à corriger :** contrastes non contrôlés lors de la personnalisation, dépendance à `:focus-visible`, opacité configurable sans garde-fou, panneau debug non audité. Ces éléments peuvent faire échouer un audit RGAA si les réglages sont mal utilisés.【F:ma-galerie-automatique/includes/Frontend/Assets.php†L452-L479】【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L185-L189】【F:ma-galerie-automatique/assets/js/src/debug.js†L31-L147】

## Recommandations complémentaires
- Ajouter des tests automatisés (PHPUnit/Playwright) pour valider les scénarios clefs : ouverture du lightbox, navigation clavier, activation du partage, respect du focus après fermeture.
- Fournir une checklist d’accessibilité dans l’interface admin signalant les réglages à risque (contraste, opacité, animations).
- Documenter le coût du mode debug et, si possible, désactiver automatiquement l’instrumentation après X minutes d’inactivité pour éviter l’oubli en production.

## Plan d’action recommandé
1. Prioriser un sprint de refactorisation léger (1-2 semaines) découpé en lots indépendants : extraction des modules utilitaires JavaScript, ajout des tests unitaires puis intégration continue (GitHub Actions).【F:ma-galerie-automatique/assets/js/src/gallery-slideshow.js†L1-L4637】
2. Déployer simultanément les correctifs CSS pour le focus et la validation de contraste, car ils n’impactent pas le cœur métier et peuvent être diffusés dans une version mineure (ex. vX.Y.1).【F:ma-galerie-automatique/assets/css/gallery-slideshow.css†L185-L189】【F:ma-galerie-automatique/includes/Frontend/Assets.php†L452-L479】
3. Traiter l’accessibilité du panneau debug en parallèle de la documentation afin que les équipes internes puissent continuer à l’utiliser sans changer leurs habitudes (aucune modification d’API, uniquement du style et des attributs ARIA).【F:ma-galerie-automatique/assets/js/src/debug.js†L31-L200】
4. Communiquer les nouvelles règles (contraste minimal, opacité) dans la documentation utilisateur et fournir un script de migration qui corrige automatiquement les valeurs existantes en dessous du seuil recommandé.【F:ma-galerie-automatique/includes/Frontend/Assets.php†L462-L474】

