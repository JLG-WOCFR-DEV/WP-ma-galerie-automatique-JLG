# Audit code & accessibilitÃ© â€“ Extension Â«Â Lightbox - JLGÂ Â»

## SynthÃ¨se
- Le cÅ“ur de lâ€™extension repose sur un fichier JavaScript monolithique de plus de 4Â 600 lignes qui mÃªle dÃ©tection de contenu, gÃ©nÃ©ration du DOM, gestion de lâ€™historique, accessibilitÃ© et debug. Cette densitÃ© rend la maintenance et le test unitaire difficiles et augmente le risque de rÃ©gressions lors dâ€™Ã©volutions futures.ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L1-L4637ã€‘
- Lâ€™Ã©quipe a portÃ© une attention rÃ©elle aux besoins dâ€™accessibilitÃ© (structure de dialogue, piÃ©geage du focus, prise en compte de `prefers-reduced-motion`). NÃ©anmoins, certaines personnalisations (couleurs, opacitÃ©) peuvent facilement casser les contrastes exigÃ©s par le RGAA si lâ€™admin choisit des valeurs non conformes, faute de garde-fous dans le code.ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L452-L479ã€‘ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L1-L208ã€‘ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L605-L651ã€‘
- Les outils de diagnostic embarquÃ©s sont complets, mais leur interface statique (styles inline, absence de thÃ©matisation) nâ€™est pas vÃ©rifiÃ©e pour la conformitÃ© RGAA et pourrait poser problÃ¨me sur certains contrastes ou lecteurs dâ€™Ã©cran.ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L19-L200ã€‘

## Points forts constatÃ©s
- CrÃ©ation de la visionneuse avec rÃ´le `dialog`, intitulÃ© accessible et conteneur de statut pour la lÃ©gende, ce qui fournit une base solide pour la lecture par les technologies dâ€™assistance.ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L2504-L2747ã€‘
- Ouverture/fermeture gÃ©rÃ©es avec blocage du scroll, restauration du focus initial et piÃ©geage du focus clavier pendant lâ€™affichage du lightbox.ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L3600-L3680ã€‘ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L4501-L4572ã€‘
- Modal de partage gÃ©nÃ©rÃ© dynamiquement avec attributs ARIA (`aria-modal`, `aria-describedby`, `aria-live`), contrÃ´le de lâ€™Ã©tat `aria-expanded` du bouton dâ€™invocation et gestion du focus.ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L936-L1268ã€‘
- Prise en compte du media-query `prefers-reduced-motion` pour rÃ©duire les animations lorsque lâ€™utilisateur le demande.ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L605-L651ã€‘

## Risques, bugs et points de vigilance
1. **Dette technique importante dans `gallery-slideshow.js`** â€“ Le fichier agrÃ¨ge lâ€™ensemble des responsabilitÃ©s (prÃ©paration des images, gÃ©nÃ©ration HTML, navigation clavier, historique, debug). La moindre rÃ©gression devient difficile Ã  isoler, et il est ardu de couvrir ce code par des tests ciblÃ©s.ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L1-L4637ã€‘<br>ğŸ‘‰Â **Solution proposÃ©eÂ :** introduire progressivement des modules ES (ou des fichiers sÃ©parÃ©s importÃ©s via lâ€™outil de build existant) pour lister les dÃ©pendances sans toucher aux API publiquesÂ : commencer par isoler les fonctions pures (`buildSlideMarkup`, `applyKeyboardNavigation`, etc.) dans `src/modules/`, puis exposer un point dâ€™entrÃ©e unique qui rÃ©-exporte les fonctions historiques. Ce dÃ©coupage peut Ãªtre fait feature par feature avec des tests unitaires ciblÃ©s afin de limiter tout risque de rÃ©gression.
2. **Focus visible dÃ©pendant de `:focus-visible`** â€“ Pour plusieurs contrÃ´les (`.mga-toolbar-button`, vignettes, flÃ¨ches Swiper), le style par dÃ©faut supprime lâ€™outline (`outline: none`) et le remplacement est appliquÃ© uniquement via `:focus-visible`. Les navigateurs ne supportant pas ce pseudo-sÃ©lecteur (ou en configuration particuliÃ¨re) pourraient afficher aucun indicateur visuel, ce qui contrevient au RGAAÂ 10.7.ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L185-L189ã€‘ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L413-L416ã€‘<br>ğŸ‘‰Â **Solution proposÃ©eÂ :** ajouter dans la feuille `gallery-slideshow.css` une rÃ¨gle `.mga-toolbar-button:focus:not(:focus-visible)` qui restaure un `outline` contrastÃ© (ex.Â `2px solid var(--mga-accent-color)`) et, pour les vignettes, un contour `box-shadow`. Cette modification est purement CSS et nâ€™impacte pas la logique JavaScript.
3. **Absence de contrÃ´le de contraste sur les personnalisations** â€“ Les rÃ©glages exposent `accent_color` et `bg_opacity` sans vÃ©rifier que la couleur choisie respecte les rapports de contraste requis lorsquâ€™elle est appliquÃ©e aux boutons, icÃ´nes ou au fond du viewer. Un administrateur peut ainsi dÃ©finir un accent clair sur fond clair ou une opacitÃ© trÃ¨s faible, gÃ©nÃ©rant un affichage non conforme au RGAAÂ 3.2/3.3.ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L452-L479ã€‘ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L1-L208ã€‘<br>ğŸ‘‰Â **Solution proposÃ©eÂ :** dans `Assets.php`, utiliser `wp_check_font_size()` ou un calcul maison (luminositÃ© relative WCAG) avant de persister lâ€™optionÂ : si le contraste est <Â 4.5Â :1 pour le texte ou <Â 3Â :1 pour les icÃ´nes, dÃ©clencher `add_settings_error` pour empÃªcher lâ€™enregistrement. Fournir en parallÃ¨le une prÃ©visualisation dans la page dâ€™options avec un message dâ€™avertissement, ce qui laisse lâ€™UX intacte.
4. **Debug panel non thÃ©mable** â€“ Le panneau de diagnostic est construit avec des styles inline et des codes couleur (#4CAF50, #FFC107, #FFEB3B) sur fond sombre. Aucun mÃ©canisme nâ€™assure que les contrastes restent suffisants, ni que lâ€™Ã©lÃ©ment soit ignorÃ© par les lecteurs dâ€™Ã©cran quand il nâ€™est pas actif. Cela peut gÃªner les tests dâ€™accessibilitÃ© cÃ´tÃ© client final.ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L31-L147ã€‘<br>ğŸ‘‰Â **Solution proposÃ©eÂ :** dÃ©placer les styles inline vers une feuille `debug.css` chargÃ©e conditionnellement lorsque `debug_mode` est actif, dÃ©finir des classes (`.mga-debug-success`, `.mga-debug-warning`) avec des couleurs AA et appliquer `aria-hidden="true"` lorsque le panneau est rÃ©duit. Les annonces dâ€™ouverture/fermeture peuvent Ãªtre gÃ©rÃ©es en ajoutant un Ã©lÃ©ment `div` `role="status"` mis Ã  jour via `textContent`, sans modifier la logique mÃ©tier.
5. **ParamÃ¨tre dâ€™opacitÃ© du fond** â€“ `bg_opacity` peut Ãªtre ramenÃ© Ã  zÃ©ro, rendant le fond transparent et laissant le contenu sous-jacent nuire Ã  la lisibilitÃ© du diaporama (RGAAÂ 10.5). Aucun plafond plancher nâ€™est imposÃ© en dehors de la borne mathÃ©matique.ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L462-L474ã€‘<br>ğŸ‘‰Â **Solution proposÃ©eÂ :** appliquer `max(0.6, min(1, valeur))` lors de la gÃ©nÃ©ration du CSS (cÃ´tÃ© PHP) et afficher un avertissement si lâ€™utilisateur tente dâ€™enregistrer une valeur <Â 0.6. Cette contrainte prÃ©serve la compatibilitÃ© avec les rÃ©glages actuels tout en empÃªchant un fond totalement transparent.

## Ã‰valuation du debug embarquÃ©
- Le module debug expose un panneau riche (horloge, journal des Ã©vÃ©nements, bouton Â«Â forcer lâ€™ouvertureÂ Â») et trace la plupart des actions du lightbox.ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L31-L200ã€‘ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L685-L3932ã€‘
- Lâ€™intÃ©gration est propre (feature flag `debug_mode`, chargement conditionnel du script). Cependant, le cycle de vie repose sur un `setInterval` de 100Â ms et sur des appels frÃ©quents Ã  `debug.log`, ce qui peut alourdir le thread principal si le mode reste activÃ© sur un site de production.ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L161-L185ã€‘ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L685-L3892ã€‘<br>ğŸ‘‰Â Limiter les rafraÃ®chissements quand le panneau est rÃ©duit/invisible, et documenter que le mode est rÃ©servÃ© aux environnements de recette.

## RGAAÂ : conformitÃ© observÃ©e
- **PositifÂ :** structure du modal conforme (role, aria-labelledby, aria-describedby), gestion du focus et du scroll, lÃ©gende en `aria-live`, boutons avec libellÃ©s explicites, navigation clavier sur miniatures (flÃ¨ches, Home/End).ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L936-L1268ã€‘ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L3470-L3527ã€‘
- **Points Ã  corrigerÂ :** contrastes non contrÃ´lÃ©s lors de la personnalisation, dÃ©pendance Ã  `:focus-visible`, opacitÃ© configurable sans garde-fou, panneau debug non auditÃ©. Ces Ã©lÃ©ments peuvent faire Ã©chouer un audit RGAA si les rÃ©glages sont mal utilisÃ©s.ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L452-L479ã€‘ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L185-L189ã€‘ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L31-L147ã€‘

## Recommandations complÃ©mentaires
- Ajouter des tests automatisÃ©s (PHPUnit/Playwright) pour valider les scÃ©narios clefsÂ : ouverture du lightbox, navigation clavier, activation du partage, respect du focus aprÃ¨s fermeture.
- Fournir une checklist dâ€™accessibilitÃ© dans lâ€™interface admin signalant les rÃ©glages Ã  risque (contraste, opacitÃ©, animations).
- Documenter le coÃ»t du mode debug et, si possible, dÃ©sactiver automatiquement lâ€™instrumentation aprÃ¨s X minutes dâ€™inactivitÃ© pour Ã©viter lâ€™oubli en production.

## Plan dâ€™action recommandÃ©
1. Prioriser un sprint de refactorisation lÃ©ger (1-2 semaines) dÃ©coupÃ© en lots indÃ©pendantsÂ : extraction des modules utilitaires JavaScript, ajout des tests unitaires puis intÃ©gration continue (GitHub Actions).ã€F:ma-galerie-automatique/assets/js/src/gallery-slideshow.jsâ€ L1-L4637ã€‘
2. DÃ©ployer simultanÃ©ment les correctifs CSS pour le focus et la validation de contraste, car ils nâ€™impactent pas le cÅ“ur mÃ©tier et peuvent Ãªtre diffusÃ©s dans une version mineure (ex.Â vX.Y.1).ã€F:ma-galerie-automatique/assets/css/gallery-slideshow.cssâ€ L185-L189ã€‘ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L452-L479ã€‘
3. Traiter lâ€™accessibilitÃ© du panneau debug en parallÃ¨le de la documentation afin que les Ã©quipes internes puissent continuer Ã  lâ€™utiliser sans changer leurs habitudes (aucune modification dâ€™API, uniquement du style et des attributs ARIA).ã€F:ma-galerie-automatique/assets/js/src/debug.jsâ€ L31-L200ã€‘
4. Communiquer les nouvelles rÃ¨gles (contraste minimal, opacitÃ©) dans la documentation utilisateur et fournir un script de migration qui corrige automatiquement les valeurs existantes en dessous du seuil recommandÃ©.ã€F:ma-galerie-automatique/includes/Frontend/Assets.phpâ€ L462-L474ã€‘

