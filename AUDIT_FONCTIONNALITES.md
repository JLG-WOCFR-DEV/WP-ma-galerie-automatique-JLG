# Audit des fonctions et recommandations

## Fonctions prioritaires √† am√©liorer

1. **`Detection::detect_post_linked_images`** ‚Äì La d√©tection repose sur une analyse r√©cursive des blocs suivie d'une expression r√©guli√®re g√©n√©rique sur le HTML brut. Cela reste fragile face aux attributs modernes (`data-src`, `loading="lazy"`, `<figure>` complexes) et ne tient pas compte des m√©dias charg√©s dynamiquement. Les solutions professionnelles s'appuient sur des parseurs DOM tol√©rants, des heuristiques sp√©cifiques par bloc et un cache diff√©renci√© (par post type, par langue) pour r√©duire les faux positifs et acc√©l√©rer les r√©ponses.„ÄêF:ma-galerie-automatique/includes/Content/Detection.php‚Ä†L142-L200„Äë

2. **`Detection::blocks_contain_linked_media`** ‚Äì L'algorithme suit les blocs r√©utilisables via un cache statique, mais il r√©alise des appels `get_post()` synchrones et ne diff√©rencie pas les blocs dynamiques (Query Loop, galeries distantes). Les produits ¬´ pro ¬ª pr√©chargent les r√©f√©rences via `rest_do_request`, m√©morisent les IDs visit√©s par requ√™te et appliquent une strat√©gie de timeout ou de files d'attente pour √©viter les cascades r√©cursives co√ªteuses lorsque le contenu comporte de nombreuses r√©f√©rences crois√©es.„ÄêF:ma-galerie-automatique/includes/Content/Detection.php‚Ä†L247-L305„Äë

3. **`Plugin::load_textdomain`** ‚Äì Le fallback bas√© sur un fichier `.mo` encod√© en base64 implique des lectures/√©critures disque √† chaque chargement et ne respecte pas les hooks `switch_locale`. Les alternatives professionnelles d√©placent cette logique vers un service d‚Äôinternationalisation d√©di√©, exploitent `WP_Filesystem` pour la gestion des fichiers temporaires et mettent en cache le chargement par langue (transients ou objet-cache) pour supprimer les I/O redondants.„ÄêF:ma-galerie-automatique/includes/Plugin.php‚Ä†L66-L119„Äë

4. **`Frontend\Assets::enqueue_assets`** ‚Äì Le chargement des assets injecte syst√©matiquement Swiper et les styles associ√©s, sans diff√©rencier les vues ni proposer de d√©coupage conditionnel (par exemple d√©sactiver les miniatures ou le module de partage). Les solutions pro d√©coupent les bundles (ES modules, CSS critiques), ajoutent des pr√©chargements (`wp_enqueue_scripts` + `wp_resource_hints`) et g√®rent les d√©pendances via `wp_register_*` pour permettre aux th√®mes de substituer facilement les ressources.„ÄêF:ma-galerie-automatique/includes/Frontend/Assets.php‚Ä†L23-L177„Äë

5. **`Plugin::register_block` / `prepare_block_settings`** ‚Äì Le bloc √©diteur expose uniquement un script d‚Äôaper√ßu mais aucun `view_script`, `render_callback` ou gestion dynamique des attributs. Les √©diteurs avanc√©s alignent les options du bloc sur les r√©glages front (synchronisation par REST, pr√©visualisation SSR) et valident les couleurs/typographies c√¥t√© serveur afin d‚Äô√©viter les divergences de rendu entre √©diteur et front.„ÄêF:ma-galerie-automatique/includes/Plugin.php‚Ä†L157-L244„Äë

6. **`Plugin::maybe_purge_detection_cache`** ‚Äì La purge invalide l‚Äôensemble du cache d√®s qu‚Äôun param√®tre de d√©tection varie. Des solutions plus fines segmentent par type de contenu ou par site multilingue, et enregistrent des journaux d‚Äôinvalidation pour aider au diagnostic lors d‚Äôun pic de recalcul.„ÄêF:ma-galerie-automatique/includes/Plugin.php‚Ä†L246-L335„Äë

### Feuille de route technique d√©taill√©e

| Fonction | Semaine cible | √âtapes recommand√©es | Tests √† pr√©voir | Indicateurs | Risques / mitigation |
| --- | --- | --- | --- | --- | --- |
| `Detection::detect_post_linked_images` | Semaine 1-3 | ‚Ä¢ Introduire un parseur DOM (`HTML5DOMDocument`) et une couche d‚Äôabstraction des s√©lecteurs.<br>‚Ä¢ Ajouter un cache transitoire bas√© sur (post ID, langue, hash r√©glages).<br>‚Ä¢ Isoler les heuristiques par bloc dans des classes d√©di√©es pour pr√©parer les extensions tierces. | ‚Ä¢ Tests PHPUnit couvrant les blocs `core/gallery`, `core/image`, Query Loop.<br>‚Ä¢ Tests E2E Playwright pour galeries mixtes (image + vid√©o). | ‚Ä¢ Temps moyen de d√©tection sur 100 articles.<br>‚Ä¢ Nombre de faux positifs remont√©s via debug mode. | ‚Ä¢ R√©gression sur blocs tiers ‚Üí pr√©voir un mode r√©trocompatibilit√© activable via filtre. |
| `Detection::blocks_contain_linked_media` | Semaine 2-4 | ‚Ä¢ Mettre en place un pr√©chargement des blocs r√©utilisables (`REST API`).<br>‚Ä¢ Introduire une liste de blocs dynamiques connus et un timeout pour √©viter les boucles.<br>‚Ä¢ Exposer un hook pour enregistrer des strat√©gies custom. | ‚Ä¢ Tests unitaires simulant des boucles imbriqu√©es.<br>‚Ä¢ Tests de performance sur pages avec 10+ blocs r√©utilisables. | ‚Ä¢ Nombre de requ√™tes `get_post()`.<br>‚Ä¢ Temps maximal de parcours des blocs. | ‚Ä¢ Risque de surcharge REST ‚Üí limiter les batchs et journaliser les erreurs. |
| `Plugin::load_textdomain` | Semaine 3-4 | ‚Ä¢ Externaliser la logique dans `TranslationManager`.<br>‚Ä¢ Supporter `switch_locale` et multisite via caches segment√©s.<br>‚Ä¢ Mettre en place une migration pour supprimer le fallback base64 √† terme. | ‚Ä¢ Tests PHPUnit `switch_to_locale`.<br>‚Ä¢ Test manuel multisite + plugin de traduction. | ‚Ä¢ Temps de chargement du textdomain.<br>‚Ä¢ Nombre d‚ÄôE/S disque par requ√™te. | ‚Ä¢ Perte de traductions custom ‚Üí documenter un guide de migration + hook de fallback. |
| `Frontend\\Assets::enqueue_assets` | Semaine 4-6 | ‚Ä¢ Enregistrer chaque fonctionnalit√© (`core`, `thumbs`, `share`, `debug`) via `wp_register_*`.<br>‚Ä¢ Ajouter un m√©canisme de chargement conditionnel + lazy-loading.<br>‚Ä¢ Documenter un guide de surcharge th√®me. | ‚Ä¢ Tests PHPUnit (simulation WordPress enqueue).<br>‚Ä¢ Audit Lighthouse/WebPageTest avant/apr√®s. | ‚Ä¢ Poids total bundle.<br>‚Ä¢ Score performance Lighthouse. | ‚Ä¢ Compatibilit√© th√®me ‚Üí pr√©voir un filtre de repli pour charger l‚Äôancien bundle. |
| `Plugin::register_block` & `prepare_block_settings` | Semaine 5-7 | ‚Ä¢ D√©finir `block.json` complet (`viewScript`, `editorScript`, `render`).<br>‚Ä¢ Cr√©er un endpoint REST de synchronisation des r√©glages.<br>‚Ä¢ Ajouter un composant React d‚Äôaper√ßu live et presets. | ‚Ä¢ Tests Jest sur le store.<br>‚Ä¢ Tests Playwright dans Gutenberg (changement r√©glages). | ‚Ä¢ Satisfaction des b√™ta testeurs √©diteurs.<br>‚Ä¢ Alignement visuel admin/front. | ‚Ä¢ Mont√©e en charge JS ‚Üí surveiller le bundle final et lazy-load dans Gutenberg. |
| `Plugin::maybe_purge_detection_cache` | Semaine 6-8 | ‚Ä¢ Introduire un scheduler diff√©r√© pour purges massives.<br>‚Ä¢ Segmenter les metas (`_mga_cache_{lang}_{post_type}`).<br>‚Ä¢ Logguer les purges (CPT ou Action Scheduler) et exposer un √©cran d‚Äôhistorique. | ‚Ä¢ Tests PHPUnit couvrant purges diff√©r√©es et par segment.<br>‚Ä¢ Test E2E sur modification d‚Äôoption critique. | ‚Ä¢ Temps de purge.<br>‚Ä¢ Nombre d‚Äô√©v√©nements loggu√©s. | ‚Ä¢ Accumulation de jobs ‚Üí pr√©voir un m√©canisme de throttle et d‚Äôalerte. |

## Tests de d√©bogage recommand√©s

- **`DetectionSettingsPurgeTest::test_detection_setting_change_purges_cache`** : v√©rifie que la modification des types suivis supprime bien le meta `_mga_has_linked_images`. Permet de confirmer que les purges s‚Äôex√©cutent lors des changements critiques.„ÄêF:tests/phpunit/DetectionSettingsPurgeTest.php‚Ä†L12-L40„Äë
- **`DetectionSettingsPurgeTest::test_unrelated_setting_change_preserves_cache`** : garantit qu‚Äôun r√©glage hors p√©rim√®tre (ex. `debug_mode`) ne vide pas inutilement le cache, ce qui aide √† diagnostiquer les invalidations intempestives.„ÄêF:tests/phpunit/DetectionSettingsPurgeTest.php‚Ä†L42-L67„Äë
- **`DetectionSettingsPurgeTest::test_normalized_selector_equivalence_does_not_trigger_purge`** : assure que les variations de casse/espaces des s√©lecteurs ne provoquent pas de purge, utile pour isoler les divergences entre interface admin et base de donn√©es.„ÄêF:tests/phpunit/DetectionSettingsPurgeTest.php‚Ä†L69-L97„Äë

> üí° Compl√©tez ces tests PHP par une v√©rification E2E sur une page de d√©monstration (mode debug actif) afin de capturer les r√©gressions de performance lors des purges massives.
